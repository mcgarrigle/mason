#!/usr/bin/env ruby

$LIB_DIR = File.join(File.dirname(__FILE__), "..", "lib")
$LOAD_PATH << $LIB_DIR

require 'sinatra'
require 'json'
require 'mason'
require 'node'
require 'provisioner'

Mason.configure do |config|
  # put config overrides here
end

set :bind, '0.0.0.0'
set :port, Mason.config.port

helpers do

  def node
    @node ||= Node.new
  end

end

# ---------------------------------------------

get '/version' do
  {:version => Mason.version}.to_json
end

get '/node/:fqdn' do |fqdn|
  node.get_json(fqdn)
end

put '/node/:fqdn' do |fqdn|
  server = JSON.parse(request.body.read)
  node.set(server)
  Provisioner.bootfile(server, "install")
end

get '/ks/:fqdn' do |fqdn|
  server = node.get(fqdn)
  Provisioner.bootfile(server, "localdisk")
  Provisioner.kickstart(server)
end

# ---------------------------------------------
# end
